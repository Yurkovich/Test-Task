<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{% block title %}Yurkovich's TODO{% endblock %}</title>
        <link rel="stylesheet" href="static/css/styles.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap"
            rel="stylesheet"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <header>
            <div class="navbar">
                <div class="nav-item">
                    <a href="/">ГЛАВНАЯ</a>
                </div>
                <div class="nav-item">
                    <a href="/tasks">ЗАДАЧИ</a>
                </div>
                <div class="nav-item">
                    <a href="*">ИНФО</a>
                </div>
            </div>
        </header>

        <main>{% block content %} {% endblock %}</main>

        <footer></footer>

        <script>

            document.addEventListener('DOMContentLoaded', () => {
                loadTasks();
            
                const form = document.getElementById('task-form');
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    data.deadline = new Date(data.deadline).toISOString();
            
                    await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
            
                    form.reset();
                    loadTasks();
                });
            });
            
            async function loadTasks() {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();
            
                const tbody = document.getElementById('task-list-body');
                tbody.innerHTML = '';
            
                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.description}</td>
                        <td>${task.category}</td>
                        <td>${task.priority}</td>
                        <td>${task.author}</td>
                        <td>${task.deadline}</td>
                        <td>${task.completed ? 'Да' : 'Нет'}</td>
                        <td>${task.date_completed || '-'}</td>
                        <td>
                            <button onclick="editTask(${task.id})">Редактировать</button>
                            <button onclick="deleteTask(${task.id})">Удалить</button>
                            <button onclick="markAsCompleted(${task.id})" ${task.completed ? 'disabled' : ''}>Выполнено</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            async function deleteTask(id) {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                loadTasks();
            }
            
            function editTask(id) {
                // Логика для редактирования задачи
            }
            
            async function markAsCompleted(id) {
                const completedDate = new Date().toISOString(); // Получаем текущую дату и время
                await fetch(`/api/tasks/${id}/complete`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: true, date_completed: completedDate })
                });
                loadTasks(); // Перезагружаем список задач после обновления
            }
            
        </script>
        
    </body>
</html>
